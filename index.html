<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Radio DJ for Spotify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .dj-card {
            background: #1A1A1D;
            border: 1px solid #4E4E50;
        }
        .text-glow {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }
        .btn-spotify {
            background-color: #1DB954;
            transition: all 0.3s ease;
        }
        .btn-spotify:hover {
            background-color: #1ED760;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4);
        }
        .btn-primary {
            background-color: #C3073F;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #950740;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(195, 7, 63, 0.4);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #C3073F;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#0B0C10] text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div class="dj-card rounded-2xl p-6 md:p-8 shadow-2xl">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-glow">AI Radio DJ</h1>
                <p class="text-gray-400 mt-2">for Spotify</p>
            </div>

            <!-- 曲情報表示エリア -->
            <div id="song-display" class="bg-black/30 rounded-lg p-4 mb-6 min-h-[120px] flex flex-col justify-center items-center text-center">
                <p id="song-info-placeholder" class="text-gray-400">Spotifyにログインしてください</p>
                <div id="song-details" class="hidden">
                    <h2 id="song-title" class="text-2xl font-semibold text-glow">曲名</h2>
                    <p id="artist-name" class="text-gray-300 text-lg">アーティスト</p>
                </div>
            </div>

            <!-- DJトーク表示エリア -->
            <div id="dj-script-display" class="bg-black/30 rounded-lg p-4 mb-6 min-h-[100px]">
                <p id="dj-script" class="text-gray-300 italic">ここにDJのトークが表示されます...</p>
            </div>
            
            <!-- ローダーとステータス表示 -->
            <div id="status-area" class="text-center mb-6 min-h-[50px] flex flex-col justify-center items-center">
                 <div id="loader" class="loader hidden"></div>
                 <p id="status-text" class="text-gray-400 mt-2"></p>
            </div>

            <!-- 操作ボタン -->
            <div id="controls">
                <div id="login-view" class="flex justify-center mb-4">
                    <button id="login-btn" class="btn-spotify text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m4.594 14.862c-.22.36-.674.48-1.034.26-2.99-1.83-6.73-2.24-11.13-1.22-.426.1-.82-.14-.92-.56-.1-.42.14-.82.56-.92 4.77-1.1 8.87-.64 12.14 1.34.36.22.48.67.26 1.03m1.03-2.52c-.27.45-.84.6-1.29.33-3.4-2.07-8.5-2.7-12.42-1.48-.5.15-1.01-.15-1.16-.65s.15-1.01.65-1.16c4.35-1.33 9.89-.61 13.73 1.7.45.27.6.84.33 1.29M12 5.5c5.8 0 10.5 4.7 10.5 10.5S17.8 26.5 12 26.5 1.5 21.8 1.5 16 6.2 5.5 12 5.5m5.91 8.16c-.33.54-1.01.72-1.55.39-4.01-2.45-10.4-3.2-14.7-1.75-.62.21-1.26-.14-1.47-.76s.14-1.26.76-1.47c4.8-1.6 11.75-.76 16.27 1.95.54.33.72 1.01.39 1.55"></path></svg>
                        Login with Spotify
                    </button>
                </div>
                <div id="player-view" class="hidden flex justify-center mb-4">
                     <button id="play-btn" class="btn-primary text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg">
                        現在の曲で紹介を生成
                    </button>
                </div>
            </div>
        </div>
        <audio id="audio-player" class="hidden"></audio>
    </div>

    <script>
        // --- Spotify API & App Config ---
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここにSpotify for Developersで取得したあなたのClient IDを貼り付けてください ★
        const SPOTIFY_CLIENT_ID = "d6ab4c6006ef42318ef5e3ca994a9e8c"; 
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        const SPOTIFY_REDIRECT_URI = window.location.origin + window.location.pathname;
        const SPOTIFY_SCOPES = "user-read-currently-playing";
        const STATE_KEY = 'spotify_auth_state';
        
        // --- DOM要素の取得 ---
        const songTitleElement = document.getElementById('song-title');
        const artistNameElement = document.getElementById('artist-name');
        const djScriptElement = document.getElementById('dj-script');
        const playBtn = document.getElementById('play-btn');
        const loginBtn = document.getElementById('login-btn');
        const audioPlayer = document.getElementById('audio-player');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        const loginView = document.getElementById('login-view');
        const playerView = document.getElementById('player-view');
        const songInfoPlaceholder = document.getElementById('song-info-placeholder');
        const songDetails = document.getElementById('song-details');

        let spotifyAccessToken = null;
        
        // --- UIの状態管理 ---
        function setUIState(state) {
            switch (state) {
                case 'loading':
                case 'playing':
                    playBtn.disabled = true;
                    playBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    loader.classList.remove('hidden');
                    break;
                case 'idle':
                default:
                    playBtn.disabled = false;
                    playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    loader.classList.add('hidden');
                    statusText.textContent = '';
                    break;
            }
        }
        function setStatus(text) { statusText.textContent = text; }

        // --- Spotify 認証関連 ---
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        function handleSpotifyLogin() {
            if (SPOTIFY_CLIENT_ID === "") {
                alert("Spotify Client IDが設定されていません。コード内の 'SPOTIFY_CLIENT_ID' にあなたのIDを設定してください。");
                return;
            }

            const state = generateRandomString(16);
            localStorage.setItem(STATE_KEY, state);

            // ★★ URL生成方法を、よりシンプルな手動での文字列結合に変更しました ★★
            let authUrl = 'https://accounts.spotify.com/authorize';
            authUrl += '?response_type=token';
            authUrl += '&client_id=' + encodeURIComponent(SPOTIFY_CLIENT_ID);
            authUrl += '&scope=' + encodeURIComponent(SPOTIFY_SCOPES);
            authUrl += '&redirect_uri=' + encodeURIComponent(SPOTIFY_REDIRECT_URI);
            authUrl += '&state=' + encodeURIComponent(state);
            
            window.location.href = authUrl;
        }

        function getParamsFromUrl() {
            const hash = window.location.hash.substring(1);
            return new URLSearchParams(hash);
        }

        // --- Spotify API 呼び出し ---
        async function getCurrentlyPlaying() {
            if (!spotifyAccessToken) { return null; }
            setStatus("Spotifyで再生中の曲を取得中...");
            try {
                const response = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
                    headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
                });

                if (response.status === 204) {
                    setStatus("Spotifyで曲が再生されていません。");
                    songInfoPlaceholder.textContent = 'Spotifyで曲を再生してください';
                    songDetails.classList.add('hidden');
                    songInfoPlaceholder.classList.remove('hidden');
                    return null;
                }
                if (response.status === 401) {
                    spotifyAccessToken = null;
                    updateLoginState();
                    setStatus("認証が切れました。再度ログインしてください。");
                    return null;
                }
                if (!response.ok) { throw new Error(`Spotify API Error: ${response.status}`); }
                
                const data = await response.json();
                if (data && data.item) {
                     songTitleElement.textContent = data.item.name;
                     artistNameElement.textContent = data.item.artists.map(a => a.name).join(', ');
                     songDetails.classList.remove('hidden');
                     songInfoPlaceholder.classList.add('hidden');
                     return { title: data.item.name, artist: data.item.artists[0].name };
                }
                 return null;
            } catch (error) {
                console.error("Spotifyの曲情報取得に失敗:", error);
                setStatus("曲情報の取得に失敗しました。");
                return null;
            }
        }

        // --- Gemini API (変更なし) ---
        const API_KEY = ""; 
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        async function generateDjTalk(title, artist) { /* ... */ }
        async function convertTextToSpeech(textToSpeak) { /* ... */ }
        function base64ToArrayBuffer(base64) { /* ... */ }
        function pcmToWav(pcmData, sampleRate) { /* ... */ }
        function writeString(view, offset, string) { /* ... */ }
        
        // --- メインロジック ---
        async function playDjIntroForCurrentTrack() { /* ... */ }

        function updateLoginState() {
            if (spotifyAccessToken) {
                loginView.classList.add('hidden');
                playerView.classList.remove('hidden');
                songInfoPlaceholder.textContent = 'Spotifyで曲を再生してください';
                getCurrentlyPlaying();
            } else {
                loginView.classList.remove('hidden');
                playerView.classList.add('hidden');
                songInfoPlaceholder.textContent = 'Spotifyにログインしてください';
                songDetails.classList.add('hidden');
                songInfoPlaceholder.classList.remove('hidden');
            }
        }
        
        // --- イベントリスナー ---
        loginBtn.addEventListener('click', handleSpotifyLogin);
        playBtn.addEventListener('click', playDjIntroForCurrentTrack);
        audioPlayer.addEventListener('ended', () => { /* ... */ });
        audioPlayer.addEventListener('error', (e) => { /* ... */ });

        // --- 初期化 ---
        window.onload = () => {
            const params = getParamsFromUrl();
            const token = params.get('access_token');
            const state = params.get('state');
            const storedState = localStorage.getItem(STATE_KEY);

            if (token && state && state === storedState) {
                localStorage.removeItem(STATE_KEY);
                spotifyAccessToken = token;
                window.location.hash = ''; // URLをクリーンにする
            } else if (params.get('error')) {
                console.error("認証エラー:", params.get('error'));
                setStatus("Spotifyとの認証に失敗しました。");
            }
            
            updateLoginState();
            setUIState('idle');
        };

        // --- 変更のない関数の省略表示 ---
        playDjIntroForCurrentTrack = async function() { setUIState('loading'); const currentSong = await getCurrentlyPlaying(); if (!currentSong) { setUIState('idle'); return; } const djTalk = await generateDjTalk(currentSong.title, currentSong.artist); if (!djTalk) { setUIState('idle'); return; } const songIntro = `それではお聴きください。${currentSong.artist}で、${currentSong.title}。`; const fullText = `${djTalk} ${songIntro}`; const audioBase64 = await convertTextToSpeech(fullText); if (!audioBase64) { setUIState('idle'); return; } setStatus('曲紹介を再生します...'); setUIState('playing'); try { const pcmData = base64ToArrayBuffer(audioBase64); const wavBlob = pcmToWav(pcmData, 24000); const audioUrl = URL.createObjectURL(wavBlob); audioPlayer.src = audioUrl; audioPlayer.play(); } catch (error) { console.error("音声の再生に失敗:", error); setStatus('音声の再生に失敗しました。'); setUIState('idle'); } };
        generateDjTalk = async function(title, artist) { setStatus('DJがトークを考えています...'); const systemPrompt = "あなたは日本の深夜ラジオのクールで知識豊富な音楽DJです。これから流す曲について、アーティストや曲にまつわる小話や豆知識を交えながら、短く（2〜3文程度）て気の利いた紹介をしてください。"; const userPrompt = `次に流す曲は ${artist} の「${title}」です。曲紹介をお願いします。`; try { const response = await fetch(TEXT_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); const talk = result.candidates?.[0]?.content?.parts?.[0]?.text; if (talk) { djScriptElement.textContent = talk; return talk; } else { throw new Error("生成されたトークがありません。"); } } catch (error) { console.error("DJトークの生成に失敗しました:", error); djScriptElement.textContent = "トークの生成に失敗しました。もう一度試してください。"; return null; } };
        convertTextToSpeech = async function(textToSpeak) { setStatus('トークを音声に変換しています...'); try { const response = await fetch(TTS_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Say with a cool, relaxed tone: ${textToSpeak}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" }) }); if (!response.ok) throw new Error(`API Error: ${response.status}`); const result = await response.json(); const audioData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data; const mimeType = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType; if (audioData && mimeType && mimeType.startsWith("audio/")) { return audioData; } else { throw new Error("音声データが見つかりません。"); } } catch(error) { console.error("Text-to-Speechに失敗しました:", error); setStatus('音声の生成に失敗しました。'); return null; } };
        base64ToArrayBuffer = function(base64) { const binaryString = window.atob(base64); const len = binaryString.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); } return bytes.buffer; };
        pcmToWav = function(pcmData, sampleRate) { const pcm16 = new Int16Array(pcmData); const numChannels = 1; const bitsPerSample = 16; const blockAlign = (numChannels * bitsPerSample) / 8; const byteRate = sampleRate * blockAlign; const dataSize = pcm16.length * 2; const buffer = new ArrayBuffer(44 + dataSize); const view = new DataView(buffer); writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); view.setUint32(8, 'WAVE'); view.setUint32(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true); view.setUint32(36, 'data'); view.setUint32(40, dataSize, true); for (let i = 0; i < pcm16.length; i++) { view.setInt16(44 + i * 2, pcm16[i], true); } return new Blob([view], { type: 'audio/wav' }); };
        writeString = function(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } };
        audioPlayer.addEventListener('ended', () => { setStatus('（ここで音楽が再生されます）'); setTimeout(() => { setUIState('idle'); }, 3000); });
        audioPlayer.addEventListener('error', (e) => { console.error('Audio Player Error:', e); setStatus('音声ファイルの再生中にエラーが発生しました。'); setUIState('idle'); });
    </script>
</body>
</html>

